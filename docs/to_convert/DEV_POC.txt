create or replace database DEV_POC COMMENT='POC DB (Development)';

create or replace schema API;

CREATE OR REPLACE FUNCTION "GET_FACTSET_JWT_TOKEN"()
RETURNS VARCHAR
LANGUAGE PYTHON
RUNTIME_VERSION = '3.9'
PACKAGES = ('requests','joserfc')
HANDLER = 'generate_token'
EXTERNAL_ACCESS_INTEGRATIONS = (FACTSET_SANDBOX_ACCESS_INTEGRATION)
AS '
import requests
import uuid
import time
from joserfc.jwk import RSAKey
from joserfc import jwt

def generate_token():
    jwk = {
        "kty": "RSA",
        "use": "sig",
        "alg": "RS256",
        "kid": "ce5d8309c0514ffaa48458aceda14022",
        "d": "fwEhYnDv26BBnef0pvKaWmf8T27ECv-kEYvDsU_f6nNDrQNien0zKeRjwHr6eMvDjoT7ARIOt0h1k3kY7eZ5CY4tUmYm6RngqJqu61t87_NFFzSIPcNJKwOsADliZpNwyuPL5QD22866gLUZyBWFK9fAP1sEFu9-Vj4CvHZwOfYAn5YqBwgfy4e5V5SNiG8WLMICAmAFLWtQX35vUtHlxhfScf2D-C-BK0lZAUcRMchB86dgdexePYUXY1O09pOy1RIlCwKQaAebkEo-uK7LcQmLfSqUFW2rVkXhwjfu3kx_5oi3AeAEMEnBJBO8YMwyOIJF7zKnIrv2VNPPQYWHeQ",
        "n": "klJCJMKMtYr9FHzsC5JJ0Y7v_7CYHktuEcHpC1WWfwo9H9p7r5ZJRRmnl0NcQoGxAwpFpaEtdGNDPSF2K0gBMC5m8VApLvbZjArH1POvGZXOcdsochJY8gfDWneH7n47FN7eJdVdDB4SjDgDVec6GcFB0m0ztC1L_IuanDYBvSsa7WUcDlp_TvC_f5oxCOiSJAvPPFGcyOCQAs6wT7o81G5s6Wpxcw6qXNhoubD2q7-u6M6b4u6ltj-HNKnx-dl4LbPX6D6NT3aDVzg86bQvLHBmu7kSmYWrJsfuwF_GqAp6yW_Uwa4LTKs5d3FCvcoBDeHDa1MTtROsrvPP-zot5w",
        "e": "AQAB",
        "p": "znyuXt8bHFQWDUsYhTsELAu9ST3vxKSPcvYzRGUJBVVUSfiJ6jr8OX-wAiW9mCW4eujC1980nW1iHsKJiPGTm8invcxFjKAeIWMAGiaP6-o1rvjktbvS-PEzNXAGR8J4KCBNjhKwrw4dvfmwZFzRl35wlFPmlAiCF5XpZJF82wM",
        "q": "tWhFrxtRzqNHzDKQGBYTBzvRXcy5xfjeYQpvMFhVDosyPNrDQiUo3ByWWvt5tK6_18s01Jnxd2b4bsjscaUGTkRclJo532ulpU9_-Drts1AIKLO7D5dYiJTrQpmMaWpuuFYCrCmvm7TRBowHZ4lpe4STfy5tP6_d8X6crLl6Gk0",
        "dp": "JxgEC4JCJ8LjyfCF2_Oofo5acBuB4cEmR6XFXxWh95iINNkRg39XcatzL3TlyICbxOl8ulJQK94hzaEXWQ4j3ELJP24FXPKTwc50nn7ekNPvBgmpg57j-q3v_BYRmlR_W1mCVXvEZ-BMUUOM2fOY2w3dUrfv1-ckekKvxZKmCPE",
        "dq": "CrQzYGixRAsYYnEdVX5_8u5RpUI-N_M-U-WEuAqOQkRuW27hFJcSuSIqsQWjocip4zbHUEAhIlV-FTNf2DjPjXC1McOD5K36YS22tFPt0KXJRXWNdRcOD0kSNKTQxyuTiubwU25GQV7C8qryiOZvxe0FsvxvT9G1u9knr31mOgU",
        "qi": "YnN7Uk_xb7tLkTtNpwzQEb3aNkvTrE8V7leUC5zcOMqysCEkLKgx2Nbdn6Fk-yCbcEIiNyPknrLoE4SyummdpE9SE5ErX0nzeDUcJ3gH4KaKFSv_w0cbTUThtbECPWset7C3nI0seSz3wL2JUFSQ2fyd_FcwMHUlORI5USuoqFE"
    }
    issuedat= time.time()
    key_bytes = RSAKey.import_key(jwk)
    encoded_jwt = jwt.encode(
        claims = {
            "sub": "7541ff99de124abfb0ea472248044d9e",
            "iss": "7541ff99de124abfb0ea472248044d9e",
            "aud": "https://auth.factset.com",
            "nbf": issuedat - 5,
            "iat": issuedat,
            "exp": issuedat + 300,
            "jti": str(uuid.uuid4()),
        },
        key = key_bytes,
        header = {
            "alg": "RS256", 
            "kid": "ce5d8309c0514ffaa48458aceda14022",
        },
    )
    
    client_id = "7541ff99de124abfb0ea472248044d9e"
    token_url = "https://auth.factset.com/as/token.oauth2"
    # Prepare the data for the POST request
    headers = {
        "Accept": "application/json",
        "Content-Type": "application/x-www-form-urlencoded",
        }
    data = {
        "grant_type": "client_credentials",
        "client_id": client_id,
        "client_assertion": encoded_jwt,
        "client_assertion_type": "urn:ietf:params:oauth:client-assertion-type:jwt-bearer",
    }
    
    token_response = requests.post(token_url, data=data, headers=headers)
    if token_response.status_code != 200:
        return f"❌ Auth Failed: {token_response.status_code}, {token_response.text}"
    
    access_token = token_response.json().get("access_token")
 
    return access_token
';
CREATE OR REPLACE FUNCTION "GET_FACTSET_JWT_TOKEN_DATA_POC"()
RETURNS VARCHAR
LANGUAGE PYTHON
RUNTIME_VERSION = '3.9'
PACKAGES = ('requests','joserfc')
HANDLER = 'generate_token'
EXTERNAL_ACCESS_INTEGRATIONS = (FACTSET_SANDBOX_ACCESS_INTEGRATION)
AS '
import requests
import uuid
import time
from joserfc.jwk import RSAKey
from joserfc import jwt

def generate_token():
    jwk = {
        "kty": "RSA",
        "use": "sig",
        "alg": "RS256",
        "kid": "ce5d8309c0514ffaa48458aceda14022",
        "d": "fwEhYnDv26BBnef0pvKaWmf8T27ECv-kEYvDsU_f6nNDrQNien0zKeRjwHr6eMvDjoT7ARIOt0h1k3kY7eZ5CY4tUmYm6RngqJqu61t87_NFFzSIPcNJKwOsADliZpNwyuPL5QD22866gLUZyBWFK9fAP1sEFu9-Vj4CvHZwOfYAn5YqBwgfy4e5V5SNiG8WLMICAmAFLWtQX35vUtHlxhfScf2D-C-BK0lZAUcRMchB86dgdexePYUXY1O09pOy1RIlCwKQaAebkEo-uK7LcQmLfSqUFW2rVkXhwjfu3kx_5oi3AeAEMEnBJBO8YMwyOIJF7zKnIrv2VNPPQYWHeQ",
        "n": "klJCJMKMtYr9FHzsC5JJ0Y7v_7CYHktuEcHpC1WWfwo9H9p7r5ZJRRmnl0NcQoGxAwpFpaEtdGNDPSF2K0gBMC5m8VApLvbZjArH1POvGZXOcdsochJY8gfDWneH7n47FN7eJdVdDB4SjDgDVec6GcFB0m0ztC1L_IuanDYBvSsa7WUcDlp_TvC_f5oxCOiSJAvPPFGcyOCQAs6wT7o81G5s6Wpxcw6qXNhoubD2q7-u6M6b4u6ltj-HNKnx-dl4LbPX6D6NT3aDVzg86bQvLHBmu7kSmYWrJsfuwF_GqAp6yW_Uwa4LTKs5d3FCvcoBDeHDa1MTtROsrvPP-zot5w",
        "e": "AQAB",
        "p": "znyuXt8bHFQWDUsYhTsELAu9ST3vxKSPcvYzRGUJBVVUSfiJ6jr8OX-wAiW9mCW4eujC1980nW1iHsKJiPGTm8invcxFjKAeIWMAGiaP6-o1rvjktbvS-PEzNXAGR8J4KCBNjhKwrw4dvfmwZFzRl35wlFPmlAiCF5XpZJF82wM",
        "q": "tWhFrxtRzqNHzDKQGBYTBzvRXcy5xfjeYQpvMFhVDosyPNrDQiUo3ByWWvt5tK6_18s01Jnxd2b4bsjscaUGTkRclJo532ulpU9_-Drts1AIKLO7D5dYiJTrQpmMaWpuuFYCrCmvm7TRBowHZ4lpe4STfy5tP6_d8X6crLl6Gk0",
        "dp": "JxgEC4JCJ8LjyfCF2_Oofo5acBuB4cEmR6XFXxWh95iINNkRg39XcatzL3TlyICbxOl8ulJQK94hzaEXWQ4j3ELJP24FXPKTwc50nn7ekNPvBgmpg57j-q3v_BYRmlR_W1mCVXvEZ-BMUUOM2fOY2w3dUrfv1-ckekKvxZKmCPE",
        "dq": "CrQzYGixRAsYYnEdVX5_8u5RpUI-N_M-U-WEuAqOQkRuW27hFJcSuSIqsQWjocip4zbHUEAhIlV-FTNf2DjPjXC1McOD5K36YS22tFPt0KXJRXWNdRcOD0kSNKTQxyuTiubwU25GQV7C8qryiOZvxe0FsvxvT9G1u9knr31mOgU",
        "qi": "YnN7Uk_xb7tLkTtNpwzQEb3aNkvTrE8V7leUC5zcOMqysCEkLKgx2Nbdn6Fk-yCbcEIiNyPknrLoE4SyummdpE9SE5ErX0nzeDUcJ3gH4KaKFSv_w0cbTUThtbECPWset7C3nI0seSz3wL2JUFSQ2fyd_FcwMHUlORI5USuoqFE"
    }
    issuedat= time.time()
    key_bytes = RSAKey.import_key(jwk)
    encoded_jwt = jwt.encode(
        claims = {
            "sub": "7541ff99de124abfb0ea472248044d9e",
            "iss": "7541ff99de124abfb0ea472248044d9e",
            "aud": "https://auth.factset.com",
            "nbf": issuedat - 5,
            "iat": issuedat,
            "exp": issuedat + 300,
            "jti": str(uuid.uuid4()),
        },
        key = key_bytes,
        header = {
            "alg": "RS256", 
            "kid": "ce5d8309c0514ffaa48458aceda14022",
        },
    )
    
    client_id = "7541ff99de124abfb0ea472248044d9e"
    token_url = "https://auth.factset.com/as/token.oauth2"
    # Prepare the data for the POST request
    headers = {
        "Accept": "application/json",
        "Content-Type": "application/x-www-form-urlencoded",
        }
    data = {
        "grant_type": "client_credentials",
        "client_id": client_id,
        "client_assertion": encoded_jwt,
        "client_assertion_type": "urn:ietf:params:oauth:client-assertion-type:jwt-bearer",
    }
    
    token_response = requests.post(token_url, data=data, headers=headers)
    if token_response.status_code != 200:
        return f"❌ Auth Failed: {token_response.status_code}, {token_response.text}"
    
    access_token = token_response.json().get("access_token")
    
    jdata = requests.get("https://api-sandbox.factset.com/research/irn/v1/Recommendations", headers={"Authorization": "Bearer " + access_token}).json()
    
    return jdata
';
CREATE OR REPLACE FUNCTION "GET_FACTSET_RECOMMENDATIONS"()
RETURNS VARCHAR
LANGUAGE PYTHON
RUNTIME_VERSION = '3.9'
PACKAGES = ('requests','snowflake-snowpark-python')
HANDLER = 'fill_Recommendations'
EXTERNAL_ACCESS_INTEGRATIONS = (FACTSET_SANDBOX_ACCESS_INTEGRATION)
AS '
import requests
from snowflake.snowpark.functions import udf

def fill_Recommendations():
    #jdata = session.sql("select Get_FactSet_JWT_Token()").collect()
    jdata = requests.get("https://api-sandbox.factset.com/research/irn/v1/Recommendations", headers={"Authorization": "Bearer " + Get_FactSet_JWT_Token()}).json()
    return jdata
';
CREATE OR REPLACE FUNCTION "GET_FIRDS_FILES_LINKS"()
RETURNS VARCHAR
LANGUAGE PYTHON
RUNTIME_VERSION = '3.9'
PACKAGES = ('requests')
HANDLER = 'FIRDApiData'
EXTERNAL_ACCESS_INTEGRATIONS = (FIRD_ACCESS_INTEGRATION)
AS '
import requests
session = requests.Session()

def FIRDApiData():
    urlFileType = "DLTINS"
    feedStartDate = "2025-02-19"
    feedEndDate = "2025-02-19"
    baseurl = "https://api.data.fca.org.uk/fca_data_firds_files"

    urlAPI = f"{baseurl}?q=((file_type:{urlFileType})%20AND%20(publication_date:[{feedStartDate}%20TO%20{feedEndDate}]))&from=0&size=100&pretty=true"
    response = requests.get(urlAPI)
    data = [{"data" : response.json()}]
    return data
';
CREATE OR REPLACE FUNCTION "GET_MORNINGSTAR_INDEX"()
RETURNS VARCHAR
LANGUAGE PYTHON
RUNTIME_VERSION = '3.9'
PACKAGES = ('requests','snowflake-snowpark-python')
HANDLER = 'morningstarApiData'
EXTERNAL_ACCESS_INTEGRATIONS = (MORNINGSTAR_ACCESS_INTEGRATION)
SECRETS = ('access_Code'=MORNINGSTAR_API)
AS '
import _snowflake
import requests
session = requests.Session()

def morningstarApiData():
    access_code = _snowflake.get_generic_secret_string(''access_code'')
    startdate = "2024-02-19"
    enddate = "2024-02-19"
    urlAPI = f"https://api.morningstar.com/service/mf/DailyMarketReturnIndex/mstarid/F000011CPC?accesscode={access_code}&startdate={startdate}&enddate={enddate}&frequency=D"
    data = requests.get(urlAPI).content
    return data
';
CREATE OR REPLACE FUNCTION "GET_XPLAN_PREPROD_SESSION"()
RETURNS VARCHAR
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
PACKAGES = ('requests','snowflake-snowpark-python')
HANDLER = 'XPLANPreprodApiData'
EXTERNAL_ACCESS_INTEGRATIONS = (XPLAN_PREPROD_ACCESS_INTEGRATION)
SECRETS = ('cred'=XPLAN_PREPROD_API_PW,'apikey'=XPLAN_PREPROD_API_KEY)
AS '
import _snowflake
import requests
import base64
from requests.auth import HTTPBasicAuth
session = requests.Session()

def XPLANPreprodApiData():
    apikey = _snowflake.get_generic_secret_string(''apikey'')
    cred = _snowflake.get_username_password(''cred'')
    basic = HTTPBasicAuth(cred.username, cred.password)

    headers = {
        "x-xplan-app-id": apikey
        }
    url= f"https://cbampreprod.xplan.iress.co.uk/resourceful/entity/client-v4/1155444"
    
    response = requests.get(url, headers = headers, auth=basic)
    return response.content
';
CREATE OR REPLACE FUNCTION "TESTBASE64"()
RETURNS VARCHAR
LANGUAGE PYTHON
RUNTIME_VERSION = '3.8'
HANDLER = 'myfun'
AS '
import base64

def myfun():
    testq = b64encode(''Kashif'')
    return testq
';
create or replace schema BB_PL;

create or replace TABLE DEPARTMENTS (
	DEPT_ID NUMBER(4,0) NOT NULL,
	DEPARTMENT_NAME VARCHAR(30) NOT NULL,
	MANAGER_ID NUMBER(6,0),
	LOCATION_ID NUMBER(4,0),
	primary key (DEPT_ID)
);
create or replace schema COVID;

create or replace view COVID_DEATHS(
	COUNTRY,
	DEATHS
) as

    SELECT $1 AS COUNTRY, $2 DEATHS
    FROM @WHO_COVID_DATA/Deaths.csv
    (FILE_FORMAT => CSV_BASIC);
create or replace view COVID_VACCINATIONS(
	COUNTRY,
	VACCINATIONS
) as

    SELECT $1 AS COUNTRY, $2 VACCINATIONS
    FROM @WHO_COVID_DATA/Vaccines.csv
    (FILE_FORMAT => CSV_BASIC);
create or replace view POPULATION(
	COUNTRY,
	POPULATION
) as

    SELECT $1 AS COUNTRY, $2 POPULATION
    FROM @WHO_COVID_DATA/Population.csv
    (FILE_FORMAT => CSV_BASIC);
CREATE OR REPLACE FILE FORMAT CSV_BASIC
	SKIP_HEADER = 1
	TRIM_SPACE = TRUE
	FIELD_OPTIONALLY_ENCLOSED_BY = '\"'
;
create or replace schema DQ;

create or replace TABLE CUSTOMERS (
	ACCOUNT_NUMBER NUMBER(38,0),
	FIRST_NAME VARCHAR(16777216),
	LAST_NAME VARCHAR(16777216),
	EMAIL VARCHAR(16777216),
	PHONE VARCHAR(16777216),
	CREATED_AT TIMESTAMP_NTZ(9),
	STREET VARCHAR(16777216),
	CITY VARCHAR(16777216),
	STATE VARCHAR(16777216),
	COUNTRY VARCHAR(16777216),
	ZIP_CODE NUMBER(38,0)
);
create or replace TABLE EMPLOYEESTABLE (
	ID NUMBER(38,0),
	NAME VARCHAR(16777216),
	LAST_NAME VARCHAR(16777216),
	EMAIL VARCHAR(16777216),
	ZIP_CODE NUMBER(38,0)
);
CREATE OR REPLACE DATA METRIC FUNCTION "INVALID_EMAIL_COUNT"("ARG_T" TABLE(VARCHAR))
RETURNS NUMBER(38,0)
LANGUAGE SQL
AS 'SELECT COUNT_IF(FALSE = (
    ARG_C1 REGEXP ''^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+.[A-Za-z]{2,4}$''))
    FROM ARG_T';
create or replace schema ML;

create or replace TABLE ACTUAL_DATA (
	ENTITY_ID NUMBER(38,0),
	FAMILY_ID NUMBER(38,0),
	ENTITY_TYPE VARCHAR(16777216),
	SEX VARCHAR(16777216),
	DATE_OF_DEATH VARCHAR(16777216),
	CLIENT_ADVISER VARCHAR(16777216),
	ADVISER_FAMILY_COUNT NUMBER(38,0),
	CLIENT_ADVISER_EXECUTIVE VARCHAR(16777216),
	CLIENT_STATUS VARCHAR(16777216),
	DOB VARCHAR(16777216),
	AGE NUMBER(38,0),
	ACQUISITION VARCHAR(16777216),
	VULNERABILITY_REASON_DETAIL VARCHAR(16777216),
	LAST_LOGIN_DATE VARCHAR(16777216),
	MARKETING_PREFERENCES VARCHAR(16777216),
	MAILING_METHOD VARCHAR(16777216),
	SERVICE_PROPOSITION VARCHAR(16777216),
	CREATED_DATE VARCHAR(16777216),
	CLIENT_ADVISER_IS_REMOTE NUMBER(38,0),
	PROPOSED_PRACTICE VARCHAR(16777216),
	CLIENT_ADVISER_PRACTICE VARCHAR(16777216),
	IS_ADVISED NUMBER(38,0),
	IS_HNW NUMBER(38,0),
	IS_SELF_DIRECTED NUMBER(38,0),
	IS_IM_ONLY NUMBER(38,0),
	IS_ADVICE_OPT_OUT NUMBER(38,0),
	IS_IFA NUMBER(38,0),
	LAST_REVIEW VARCHAR(16777216),
	DAYS_SINCE_LAST_REVIEW NUMBER(38,0),
	TOTAL_COMPLAINTS NUMBER(38,0),
	LAST_COMPLAINT VARCHAR(16777216),
	DAYS_SINCE_LAST_COMPLAINT NUMBER(38,0),
	TOTAL_FAMILY_RELATIONSHIPS NUMBER(38,0),
	INVESTMENT_MANAGER VARCHAR(16777216),
	TEAM VARCHAR(16777216),
	CITS_MANAGER VARCHAR(16777216),
	CLIENT_START VARCHAR(16777216),
	SOURCE_OF_WEALTH VARCHAR(16777216),
	MARITAL_STATUS VARCHAR(16777216),
	SOURCE_OF_WEALTH2 VARCHAR(16777216),
	ACQUISITION2 VARCHAR(16777216),
	PRODUCTS VARCHAR(16777216),
	TOTAL_ADVISERS NUMBER(38,0),
	LAST_ADVISER_CHANGE VARCHAR(16777216),
	INCORRECT_PRACTICE_LOCATION NUMBER(38,0),
	PROPOSED_PRACTICE2 VARCHAR(16777216),
	CLIENT_ANNUAL_ONGOING_INCOME NUMBER(38,2),
	TOTAL_PORTFOLIO_VALUE NUMBER(38,2),
	TOTAL_PORTFOLIO_TCA NUMBER(38,2),
	TOTAL_PORTFOLIO_AUM NUMBER(38,2),
	TOTAL_PORTFOLIO_AUA NUMBER(38,2),
	TOTAL_PORTFOLIO_PULSE_AUM NUMBER(38,2),
	TOTAL_PORTFOLIO_THIRD_PARTY_AUM NUMBER(38,2),
	ACQUISITION3 VARCHAR(16777216),
	LAST_12_MONTHS_WITHDRAWALS NUMBER(38,2),
	LAST_6_MONTHS_WITHDRAWALS NUMBER(38,2),
	LAST_3_MONTHS_WITHDRAWALS NUMBER(38,2),
	LAST_1_MONTHS_WITHDRAWALS NUMBER(38,2),
	TOTAL_WITHDRAWALS NUMBER(38,2)
);
create or replace TABLE ACTUAL_DATA_CLASSIFICATION_V1 (
	ENTITY_ID NUMBER(38,0),
	SEX VARCHAR(16777216),
	CLIENT_ADVISER VARCHAR(16777216),
	CLIENT_STATUS VARCHAR(16777216),
	AGE NUMBER(38,0),
	ACQUISITION VARCHAR(16777216),
	VULNERABLE NUMBER(1,0),
	IS_ADVISED NUMBER(38,0),
	IS_HNW NUMBER(38,0),
	IS_SELF_DIRECTED NUMBER(38,0),
	IS_IM_ONLY NUMBER(38,0),
	IS_ADVICE_OPT_OUT NUMBER(38,0),
	IS_IFA NUMBER(38,0),
	DAYS_SINCE_LAST_REVIEW NUMBER(38,0),
	TOTAL_COMPLAINTS NUMBER(38,0),
	LAST_COMPLAINT VARCHAR(16777216),
	DAYS_SINCE_LAST_COMPLAINT NUMBER(38,0),
	INVESTMENT_MANAGER VARCHAR(16777216),
	TEAM VARCHAR(16777216),
	CITS_MANAGER VARCHAR(16777216),
	INCORRECT_PRACTICE_LOCATION NUMBER(38,0),
	CLIENT_ANNUAL_ONGOING_INCOME NUMBER(38,2),
	TOTAL_PORTFOLIO_VALUE NUMBER(38,2),
	TOTAL_PORTFOLIO_TCA NUMBER(38,2),
	TOTAL_PORTFOLIO_AUM NUMBER(38,2),
	TOTAL_PORTFOLIO_AUA NUMBER(38,2),
	TOTAL_PORTFOLIO_PULSE_AUM NUMBER(38,2),
	TOTAL_PORTFOLIO_THIRD_PARTY_AUM NUMBER(38,2),
	SIPP NUMBER(1,0),
	GENERAL_INVESTMENT_ACCOUNT NUMBER(1,0),
	ISA NUMBER(1,0),
	INVESTMENT_BOND NUMBER(1,0),
	PROTECTION NUMBER(1,0),
	PROPORTION_OF_WITHDRAW_NMONEY NUMBER(38,8),
	PREDICTIONS VARIANT
);
create or replace TABLE ACTUAL_DATA_TEST (
	ENTITY_ID NUMBER(38,0),
	SEX VARCHAR(16777216),
	CLIENT_ADVISER VARCHAR(16777216),
	CLIENT_STATUS VARCHAR(16777216),
	AGE NUMBER(38,0),
	ACQUISITION VARCHAR(16777216),
	VULNERABLE NUMBER(1,0),
	IS_ADVISED NUMBER(38,0),
	IS_HNW NUMBER(38,0),
	IS_SELF_DIRECTED NUMBER(38,0),
	IS_IM_ONLY NUMBER(38,0),
	IS_ADVICE_OPT_OUT NUMBER(38,0),
	IS_IFA NUMBER(38,0),
	DAYS_SINCE_LAST_REVIEW NUMBER(38,0),
	TOTAL_COMPLAINTS NUMBER(38,0),
	LAST_COMPLAINT VARCHAR(16777216),
	DAYS_SINCE_LAST_COMPLAINT NUMBER(38,0),
	INVESTMENT_MANAGER VARCHAR(16777216),
	TEAM VARCHAR(16777216),
	CITS_MANAGER VARCHAR(16777216),
	INCORRECT_PRACTICE_LOCATION NUMBER(38,0),
	CLIENT_ANNUAL_ONGOING_INCOME NUMBER(38,2),
	TOTAL_PORTFOLIO_VALUE NUMBER(38,2),
	TOTAL_PORTFOLIO_TCA NUMBER(38,2),
	TOTAL_PORTFOLIO_AUM NUMBER(38,2),
	TOTAL_PORTFOLIO_AUA NUMBER(38,2),
	TOTAL_PORTFOLIO_PULSE_AUM NUMBER(38,2),
	TOTAL_PORTFOLIO_THIRD_PARTY_AUM NUMBER(38,2),
	SIPP NUMBER(1,0),
	GENERAL_INVESTMENT_ACCOUNT NUMBER(1,0),
	ISA NUMBER(1,0),
	INVESTMENT_BOND NUMBER(1,0),
	PROTECTION NUMBER(1,0),
	PROPORTION_OF_WITHDRAW_NMONEY NUMBER(38,8)
);
create or replace TABLE ACTUAL_DATA_TRAIN (
	ENTITY_ID NUMBER(38,0),
	SEX VARCHAR(16777216),
	CLIENT_ADVISER VARCHAR(16777216),
	CLIENT_STATUS VARCHAR(16777216),
	AGE NUMBER(38,0),
	ACQUISITION VARCHAR(16777216),
	VULNERABLE NUMBER(1,0),
	IS_ADVISED NUMBER(38,0),
	IS_HNW NUMBER(38,0),
	IS_SELF_DIRECTED NUMBER(38,0),
	IS_IM_ONLY NUMBER(38,0),
	IS_ADVICE_OPT_OUT NUMBER(38,0),
	IS_IFA NUMBER(38,0),
	DAYS_SINCE_LAST_REVIEW NUMBER(38,0),
	TOTAL_COMPLAINTS NUMBER(38,0),
	LAST_COMPLAINT VARCHAR(16777216),
	DAYS_SINCE_LAST_COMPLAINT NUMBER(38,0),
	INVESTMENT_MANAGER VARCHAR(16777216),
	TEAM VARCHAR(16777216),
	CITS_MANAGER VARCHAR(16777216),
	INCORRECT_PRACTICE_LOCATION NUMBER(38,0),
	CLIENT_ANNUAL_ONGOING_INCOME NUMBER(38,2),
	TOTAL_PORTFOLIO_VALUE NUMBER(38,2),
	TOTAL_PORTFOLIO_TCA NUMBER(38,2),
	TOTAL_PORTFOLIO_AUM NUMBER(38,2),
	TOTAL_PORTFOLIO_AUA NUMBER(38,2),
	TOTAL_PORTFOLIO_PULSE_AUM NUMBER(38,2),
	TOTAL_PORTFOLIO_THIRD_PARTY_AUM NUMBER(38,2),
	SIPP NUMBER(1,0),
	GENERAL_INVESTMENT_ACCOUNT NUMBER(1,0),
	ISA NUMBER(1,0),
	INVESTMENT_BOND NUMBER(1,0),
	PROTECTION NUMBER(1,0),
	PROPORTION_OF_WITHDRAW_NMONEY NUMBER(38,8),
	HAS_12_MONTHS_WITHDRAWALS NUMBER(1,0)
);
create or replace view ACTUAL_DATA_TRAIN_VIEW(
	SEX,
	CLIENT_ADVISER,
	CLIENT_STATUS,
	AGE,
	ACQUISITION,
	VULNERABLE,
	IS_ADVISED,
	IS_HNW,
	IS_SELF_DIRECTED,
	IS_IM_ONLY,
	IS_ADVICE_OPT_OUT,
	IS_IFA,
	DAYS_SINCE_LAST_REVIEW,
	TOTAL_COMPLAINTS,
	LAST_COMPLAINT,
	DAYS_SINCE_LAST_COMPLAINT,
	INVESTMENT_MANAGER,
	TEAM,
	CITS_MANAGER,
	INCORRECT_PRACTICE_LOCATION,
	CLIENT_ANNUAL_ONGOING_INCOME,
	TOTAL_PORTFOLIO_VALUE,
	TOTAL_PORTFOLIO_TCA,
	TOTAL_PORTFOLIO_AUM,
	TOTAL_PORTFOLIO_AUA,
	TOTAL_PORTFOLIO_PULSE_AUM,
	TOTAL_PORTFOLIO_THIRD_PARTY_AUM,
	SIPP,
	GENERAL_INVESTMENT_ACCOUNT,
	ISA,
	INVESTMENT_BOND,
	PROTECTION,
	PROPORTION_OF_WITHDRAW_NMONEY,
	HAS_12_MONTHS_WITHDRAWALS
) as
 select * exclude(entity_id) from actual_Data_train;
CREATE OR REPLACE FILE FORMAT CSV
	TYPE = csv
	PARSE_HEADER = TRUE
;
create or replace schema POC;

create or replace TABLE COUNTRY (
	NAME VARCHAR(16777216),
	CODE_2CHAR VARCHAR(16777216),
	CODE_3CHAR VARCHAR(16777216),
	POPULATION NUMBER(38,0),
	POPULATION_DATE DATE
);
create or replace schema PUBLIC;

create or replace schema RJ;

create or replace sequence HIERARCHY_HIERARCHY_SQ start with 1 increment by 1 noorder;
create or replace sequence HIERARCHY_LOCATION_SQ start with 1 increment by 1 noorder;
create or replace sequence HIERARCHY_SQ start with 1 increment by 1 noorder;
create or replace sequence HIERARCHY_TEAM_SQ start with 1 increment by 1 noorder;
create or replace TABLE COMPLETE_TBL (
	PORTFOLIO_CODE VARCHAR(10),
	FUND_MANAGER_CODE VARCHAR(10),
	DATASET VARCHAR(10)
);
create or replace TABLE COMPLETE_TBL2 (
	PORTFOLIO_CODE VARCHAR(10),
	FUND_MANAGER_CODE VARCHAR(10),
	DATASET VARCHAR(10)
);
create or replace TABLE DS_DATA_2 (
	ENTITY_ID NUMBER(38,0),
	FAMILY_ID NUMBER(38,0),
	ENTITY_TYPE VARCHAR(16777216),
	SEX VARCHAR(16777216),
	DATE_OF_DEATH VARCHAR(16777216),
	CLIENT_ADVISER VARCHAR(16777216),
	ADVISER_FAMILY_COUNT NUMBER(38,0),
	CLIENT_ADVISER_EXECUTIVE VARCHAR(16777216),
	CLIENT_STATUS VARCHAR(16777216),
	DOB VARCHAR(16777216),
	AGE NUMBER(38,0),
	ACQUISITION VARCHAR(16777216),
	VULNERABILITY_REASON_DETAIL VARCHAR(16777216),
	LAST_LOGIN_DATE VARCHAR(16777216),
	MARKETING_PREFERENCES VARCHAR(16777216),
	MAILING_METHOD VARCHAR(16777216),
	SERVICE_PROPOSITION VARCHAR(16777216),
	CREATED_DATE VARCHAR(16777216),
	CLIENT_ADVISER_IS_REMOTE NUMBER(38,0),
	PROPOSED_PRACTICE VARCHAR(16777216),
	CLIENT_ADVISER_PRACTICE VARCHAR(16777216),
	IS_ADVISED NUMBER(38,0),
	IS_HNW NUMBER(38,0),
	IS_SELF_DIRECTED NUMBER(38,0),
	IS_IM_ONLY NUMBER(38,0),
	IS_ADVICE_OPT_OUT NUMBER(38,0),
	IS_IFA NUMBER(38,0),
	LAST_REVIEW VARCHAR(16777216),
	DAYS_SINCE_LAST_REVIEW NUMBER(38,0),
	TOTAL_COMPLAINTS NUMBER(38,0),
	LAST_COMPLAINT VARCHAR(16777216),
	DAYS_SINCE_LAST_COMPLAINT NUMBER(38,0),
	TOTAL_FAMILY_RELATIONSHIPS NUMBER(38,0),
	INVESTMENT_MANAGER VARCHAR(16777216),
	TEAM VARCHAR(16777216),
	CITS_MANAGER VARCHAR(16777216),
	CLIENT_START VARCHAR(16777216),
	SOURCE_OF_WEALTH VARCHAR(16777216),
	MARITAL_STATUS VARCHAR(16777216),
	SOURCE_OF_WEALTH2 VARCHAR(16777216),
	ACQUISITION2 VARCHAR(16777216),
	PRODUCTS VARCHAR(16777216),
	TOTAL_ADVISERS NUMBER(38,0),
	LAST_ADVISER_CHANGE VARCHAR(16777216),
	INCORRECT_PRACTICE_LOCATION NUMBER(38,0),
	PROPOSED_PRACTICE2 VARCHAR(16777216),
	CLIENT_ANNUAL_ONGOING_INCOME NUMBER(38,2),
	TOTAL_PORTFOLIO_VALUE NUMBER(38,2),
	TOTAL_PORTFOLIO_TCA NUMBER(38,2),
	TOTAL_PORTFOLIO_AUM NUMBER(38,2),
	TOTAL_PORTFOLIO_AUA NUMBER(38,2),
	TOTAL_PORTFOLIO_PULSE_AUM NUMBER(38,2),
	TOTAL_PORTFOLIO_THIRD_PARTY_AUM NUMBER(38,2),
	ACQUISITION3 VARCHAR(16777216),
	LAST_12_MONTHS_WITHDRAWALS NUMBER(38,2),
	LAST_6_MONTHS_WITHDRAWALS NUMBER(38,2),
	LAST_3_MONTHS_WITHDRAWALS NUMBER(38,2),
	LAST_1_MONTHS_WITHDRAWALS NUMBER(38,2),
	TOTAL_WITHDRAWALS NUMBER(38,2)
);
create or replace TABLE DS_DATA_M1 (
	ENTITY_ID NUMBER(38,0),
	FAMILY_ID NUMBER(38,0),
	ENTITY_TYPE VARCHAR(16777216),
	SEX VARCHAR(16777216),
	DATE_OF_DEATH VARCHAR(16777216),
	CLIENT_ADVISER VARCHAR(16777216),
	ADVISER_FAMILY_COUNT NUMBER(38,0),
	CLIENT_ADVISER_EXECUTIVE VARCHAR(16777216),
	CLIENT_STATUS VARCHAR(16777216),
	DOB VARCHAR(16777216),
	AGE NUMBER(38,0),
	ACQUISITION VARCHAR(16777216),
	VULNERABILITY_REASON_DETAIL VARCHAR(16777216),
	LAST_LOGIN_DATE VARCHAR(16777216),
	MARKETING_PREFERENCES VARCHAR(16777216),
	MAILING_METHOD VARCHAR(16777216),
	SERVICE_PROPOSITION VARCHAR(16777216),
	CREATED_DATE VARCHAR(16777216),
	CLIENT_ADVISER_IS_REMOTE NUMBER(38,0),
	PROPOSED_PRACTICE VARCHAR(16777216),
	CLIENT_ADVISER_PRACTICE VARCHAR(16777216),
	IS_ADVISED NUMBER(38,0),
	IS_HNW NUMBER(38,0),
	IS_SELF_DIRECTED NUMBER(38,0),
	IS_IM_ONLY NUMBER(38,0),
	IS_ADVICE_OPT_OUT NUMBER(38,0),
	IS_IFA NUMBER(38,0),
	LAST_REVIEW VARCHAR(16777216),
	DAYS_SINCE_LAST_REVIEW NUMBER(38,0),
	TOTAL_COMPLAINTS NUMBER(38,0),
	LAST_COMPLAINT VARCHAR(16777216),
	DAYS_SINCE_LAST_COMPLAINT NUMBER(38,0),
	TOTAL_FAMILY_RELATIONSHIPS NUMBER(38,0),
	INVESTMENT_MANAGER VARCHAR(16777216),
	TEAM VARCHAR(16777216),
	CITS_MANAGER VARCHAR(16777216),
	CLIENT_START VARCHAR(16777216),
	SOURCE_OF_WEALTH VARCHAR(16777216),
	MARITAL_STATUS VARCHAR(16777216),
	SOURCE_OF_WEALTH2 VARCHAR(16777216),
	ACQUISITION2 VARCHAR(16777216),
	PRODUCTS VARCHAR(16777216),
	TOTAL_ADVISERS NUMBER(38,0),
	LAST_ADVISER_CHANGE VARCHAR(16777216),
	INCORRECT_PRACTICE_LOCATION NUMBER(38,0),
	PROPOSED_PRACTICE2 VARCHAR(16777216),
	CLIENT_ANNUAL_ONGOING_INCOME NUMBER(38,2),
	TOTAL_PORTFOLIO_VALUE NUMBER(38,2),
	TOTAL_PORTFOLIO_TCA NUMBER(38,2),
	TOTAL_PORTFOLIO_AUM NUMBER(38,2),
	TOTAL_PORTFOLIO_AUA NUMBER(38,2),
	TOTAL_PORTFOLIO_PULSE_AUM NUMBER(38,2),
	TOTAL_PORTFOLIO_THIRD_PARTY_AUM NUMBER(38,2),
	ACQUISITION3 VARCHAR(16777216),
	LAST_12_MONTHS_WITHDRAWALS NUMBER(38,2),
	LAST_6_MONTHS_WITHDRAWALS NUMBER(38,2),
	LAST_3_MONTHS_WITHDRAWALS NUMBER(38,2),
	LAST_1_MONTHS_WITHDRAWALS NUMBER(38,2),
	TOTAL_WITHDRAWALS NUMBER(38,2)
);
create or replace TABLE HIERARCHY (
	ID NUMBER(38,0) DEFAULT DEV_POC.RJ.HIERARCHY_SQ.NEXTVAL,
	SOURCE_MANAGER_CODE VARCHAR(10),
	SOURCE_MANAGER VARCHAR(75),
	TEAM VARCHAR(30),
	LOCATION VARCHAR(30),
	CISI_MEMBER_NO NUMBER(38,0),
	EMPLOYEE_ID NUMBER(38,0)
);
create or replace TABLE HIERARCHY_LOCATION (
	ID NUMBER(38,0) DEFAULT DEV_POC.RJ.HIERARCHY_LOCATION_SQ.NEXTVAL,
	LOCATION VARCHAR(30)
);
create or replace TABLE HIERARCHY_TEAM (
	ID NUMBER(38,0) DEFAULT DEV_POC.RJ.HIERARCHY_TEAM_SQ.NEXTVAL,
	TEAM VARCHAR(30)
);
create or replace TABLE IDENTIFIERS (
	VARIANT_COL VARIANT
);
create or replace TABLE M1_CLASSIFICATION (
	ENTITY_ID NUMBER(38,0),
	FAMILY_ID NUMBER(38,0),
	ENTITY_TYPE VARCHAR(16777216),
	SEX VARCHAR(16777216),
	DATE_OF_DEATH VARCHAR(16777216),
	CLIENT_ADVISER VARCHAR(16777216),
	ADVISER_FAMILY_COUNT NUMBER(38,0),
	CLIENT_ADVISER_EXECUTIVE VARCHAR(16777216),
	CLIENT_STATUS VARCHAR(16777216),
	DOB VARCHAR(16777216),
	AGE NUMBER(38,0),
	ACQUISITION VARCHAR(16777216),
	VULNERABILITY_REASON_DETAIL VARCHAR(16777216),
	LAST_LOGIN_DATE VARCHAR(16777216),
	MARKETING_PREFERENCES VARCHAR(16777216),
	MAILING_METHOD VARCHAR(16777216),
	SERVICE_PROPOSITION VARCHAR(16777216),
	CREATED_DATE VARCHAR(16777216),
	CLIENT_ADVISER_IS_REMOTE NUMBER(38,0),
	PROPOSED_PRACTICE VARCHAR(16777216),
	CLIENT_ADVISER_PRACTICE VARCHAR(16777216),
	IS_ADVISED NUMBER(38,0),
	IS_HNW NUMBER(38,0),
	IS_SELF_DIRECTED NUMBER(38,0),
	IS_IM_ONLY NUMBER(38,0),
	IS_ADVICE_OPT_OUT NUMBER(38,0),
	IS_IFA NUMBER(38,0),
	LAST_REVIEW VARCHAR(16777216),
	DAYS_SINCE_LAST_REVIEW NUMBER(38,0),
	TOTAL_COMPLAINTS NUMBER(38,0),
	LAST_COMPLAINT VARCHAR(16777216),
	DAYS_SINCE_LAST_COMPLAINT NUMBER(38,0),
	TOTAL_FAMILY_RELATIONSHIPS NUMBER(38,0),
	INVESTMENT_MANAGER VARCHAR(16777216),
	TEAM VARCHAR(16777216),
	CITS_MANAGER VARCHAR(16777216),
	CLIENT_START VARCHAR(16777216),
	SOURCE_OF_WEALTH VARCHAR(16777216),
	MARITAL_STATUS VARCHAR(16777216),
	SOURCE_OF_WEALTH2 VARCHAR(16777216),
	ACQUISITION2 VARCHAR(16777216),
	PRODUCTS VARCHAR(16777216),
	TOTAL_ADVISERS NUMBER(38,0),
	LAST_ADVISER_CHANGE VARCHAR(16777216),
	INCORRECT_PRACTICE_LOCATION NUMBER(38,0),
	PROPOSED_PRACTICE2 VARCHAR(16777216),
	CLIENT_ANNUAL_ONGOING_INCOME NUMBER(38,2),
	TOTAL_PORTFOLIO_VALUE NUMBER(38,2),
	TOTAL_PORTFOLIO_TCA NUMBER(38,2),
	TOTAL_PORTFOLIO_AUM NUMBER(38,2),
	TOTAL_PORTFOLIO_AUA NUMBER(38,2),
	TOTAL_PORTFOLIO_PULSE_AUM NUMBER(38,2),
	TOTAL_PORTFOLIO_THIRD_PARTY_AUM NUMBER(38,2),
	ACQUISITION3 VARCHAR(16777216),
	LAST_12_MONTHS_WITHDRAWALS NUMBER(38,2),
	LAST_6_MONTHS_WITHDRAWALS NUMBER(38,2),
	LAST_3_MONTHS_WITHDRAWALS NUMBER(38,2),
	LAST_1_MONTHS_WITHDRAWALS NUMBER(38,2),
	TOTAL_WITHDRAWALS NUMBER(38,2),
	PREDICTIONS VARIANT
);
create or replace TABLE MY_CLASSIFICATION_V2 (
	ENTITY_ID NUMBER(38,0),
	SEX VARCHAR(16777216),
	CLIENT_ADVISER VARCHAR(16777216),
	CLIENT_STATUS VARCHAR(16777216),
	AGE NUMBER(38,0),
	ACQUISITION VARCHAR(16777216),
	VULNERABLE NUMBER(1,0),
	IS_ADVISED NUMBER(38,0),
	IS_HNW NUMBER(38,0),
	IS_SELF_DIRECTED NUMBER(38,0),
	IS_IM_ONLY NUMBER(38,0),
	IS_ADVICE_OPT_OUT NUMBER(38,0),
	IS_IFA NUMBER(38,0),
	DAYS_SINCE_LAST_REVIEW NUMBER(38,0),
	TOTAL_COMPLAINTS NUMBER(38,0),
	LAST_COMPLAINT VARCHAR(16777216),
	DAYS_SINCE_LAST_COMPLAINT NUMBER(38,0),
	INVESTMENT_MANAGER VARCHAR(16777216),
	TEAM VARCHAR(16777216),
	CITS_MANAGER VARCHAR(16777216),
	INCORRECT_PRACTICE_LOCATION NUMBER(38,0),
	CLIENT_ANNUAL_ONGOING_INCOME NUMBER(38,2),
	TOTAL_PORTFOLIO_VALUE NUMBER(38,2),
	TOTAL_PORTFOLIO_TCA NUMBER(38,2),
	TOTAL_PORTFOLIO_AUM NUMBER(38,2),
	TOTAL_PORTFOLIO_AUA NUMBER(38,2),
	TOTAL_PORTFOLIO_PULSE_AUM NUMBER(38,2),
	TOTAL_PORTFOLIO_THIRD_PARTY_AUM NUMBER(38,2),
	PREDICTIONS VARIANT
);
create or replace view HIERARCHY_V(
	"Code",
	"Manager",
	"Team",
	"Location",
	"CISI Member No",
	"Employee ID"
) as SELECT h.SOURCE_MANAGER_CODE "Code", h.SOURCE_MANAGER "Manager", COALESCE(t.TEAM, 'Unknown') "Team", COALESCE(l.LOCATION, 'Unknown') "Location", h.cisi_member_no "CISI Member No", h.employee_id "Employee ID" FROM hierarchy h LEFT JOIN hierarchy_team t ON t.id = h.team_id LEFT JOIN hierarchy_location l ON l.id = h.location_id;
create or replace view TRAINING_M1(
	ENTITY_ID,
	FAMILY_ID,
	ENTITY_TYPE,
	SEX,
	DATE_OF_DEATH,
	CLIENT_ADVISER,
	ADVISER_FAMILY_COUNT,
	CLIENT_ADVISER_EXECUTIVE,
	CLIENT_STATUS,
	DOB,
	AGE,
	ACQUISITION,
	VULNERABILITY_REASON_DETAIL,
	LAST_LOGIN_DATE,
	MARKETING_PREFERENCES,
	MAILING_METHOD,
	SERVICE_PROPOSITION,
	CREATED_DATE,
	CLIENT_ADVISER_IS_REMOTE,
	PROPOSED_PRACTICE,
	CLIENT_ADVISER_PRACTICE,
	IS_ADVISED,
	IS_HNW,
	IS_SELF_DIRECTED,
	IS_IM_ONLY,
	IS_ADVICE_OPT_OUT,
	IS_IFA,
	LAST_REVIEW,
	DAYS_SINCE_LAST_REVIEW,
	TOTAL_COMPLAINTS,
	LAST_COMPLAINT,
	DAYS_SINCE_LAST_COMPLAINT,
	TOTAL_FAMILY_RELATIONSHIPS,
	INVESTMENT_MANAGER,
	TEAM,
	CITS_MANAGER,
	CLIENT_START,
	SOURCE_OF_WEALTH,
	MARITAL_STATUS,
	SOURCE_OF_WEALTH2,
	ACQUISITION2,
	PRODUCTS,
	TOTAL_ADVISERS,
	LAST_ADVISER_CHANGE,
	INCORRECT_PRACTICE_LOCATION,
	PROPOSED_PRACTICE2,
	CLIENT_ANNUAL_ONGOING_INCOME,
	TOTAL_PORTFOLIO_VALUE,
	TOTAL_PORTFOLIO_TCA,
	TOTAL_PORTFOLIO_AUM,
	TOTAL_PORTFOLIO_AUA,
	TOTAL_PORTFOLIO_PULSE_AUM,
	TOTAL_PORTFOLIO_THIRD_PARTY_AUM,
	ACQUISITION3,
	LAST_12_MONTHS_WITHDRAWALS,
	LAST_6_MONTHS_WITHDRAWALS,
	LAST_3_MONTHS_WITHDRAWALS,
	LAST_1_MONTHS_WITHDRAWALS,
	TOTAL_WITHDRAWALS
) as 
SELECT top 1000 * from DS_DATA_2;
create or replace view TRAINING_M2_ACTUALDATA(
	ENTITY_ID,
	SEX,
	CLIENT_ADVISER,
	CLIENT_STATUS,
	AGE,
	ACQUISITION,
	VULNERABLE,
	IS_ADVISED,
	IS_HNW,
	IS_SELF_DIRECTED,
	IS_IM_ONLY,
	IS_ADVICE_OPT_OUT,
	IS_IFA,
	DAYS_SINCE_LAST_REVIEW,
	TOTAL_COMPLAINTS,
	LAST_COMPLAINT,
	DAYS_SINCE_LAST_COMPLAINT,
	INVESTMENT_MANAGER,
	TEAM,
	CITS_MANAGER,
	INCORRECT_PRACTICE_LOCATION,
	CLIENT_ANNUAL_ONGOING_INCOME,
	TOTAL_PORTFOLIO_VALUE,
	TOTAL_PORTFOLIO_TCA,
	TOTAL_PORTFOLIO_AUM,
	TOTAL_PORTFOLIO_AUA,
	TOTAL_PORTFOLIO_PULSE_AUM,
	TOTAL_PORTFOLIO_THIRD_PARTY_AUM
) as
SELECT
	ENTITY_ID,
	--FAMILY_ID,
	--ENTITY_TYPE,	
    SEX,
	--DATE_OF_DEATH,
	CLIENT_ADVISER,
	--ADVISER_FAMILY_COUNT,
	--CLIENT_ADVISER_EXECUTIVE,
	CLIENT_STATUS,
	--DOB,
	AGE,
	ACQUISITION,
	CASE WHEN VULNERABILITY_REASON_DETAIL is NULL THEN 0 ELSE 1 END as Vulnerable,
	--LAST_LOGIN_DATE,
	--MARKETING_PREFERENCES,
	--MAILING_METHOD,
	-- SERVICE_PROPOSITION like '%opt out%',  ,
	-- CREATED_DATE,
	-- CLIENT_ADVISER_IS_REMOTE,
	-- PROPOSED_PRACTICE,
	-- CLIENT_ADVISER_PRACTICE,
	IS_ADVISED,
	IS_HNW,
	IS_SELF_DIRECTED,
	IS_IM_ONLY,
	IS_ADVICE_OPT_OUT,
	IS_IFA,
	-- LAST_REVIEW,
	DAYS_SINCE_LAST_REVIEW,
	TOTAL_COMPLAINTS,
	LAST_COMPLAINT,
	DAYS_SINCE_LAST_COMPLAINT,
	-- TOTAL_FAMILY_RELATIONSHIPS,
	INVESTMENT_MANAGER,
	TEAM,
	CITS_MANAGER,
	-- CLIENT_START,
	-- SOURCE_OF_WEALTH,
	-- MARITAL_STATUS,
	-- SOURCE_OF_WEALTH2,
	-- ACQUISITION2,
	-- PRODUCTS,
	-- TOTAL_ADVISERS,
	-- LAST_ADVISER_CHANGE,
	INCORRECT_PRACTICE_LOCATION,
	-- PROPOSED_PRACTICE2,
	CLIENT_ANNUAL_ONGOING_INCOME,
	TOTAL_PORTFOLIO_VALUE,
	TOTAL_PORTFOLIO_TCA,
	TOTAL_PORTFOLIO_AUM,
	TOTAL_PORTFOLIO_AUA,
	TOTAL_PORTFOLIO_PULSE_AUM,
	TOTAL_PORTFOLIO_THIRD_PARTY_AUM,
	-- ACQUISITION3,
	--CASE WHEN CAST(LAST_12_MONTHS_WITHDRAWALS as int) < 0 THEN 1 WHEN LAST_12_MONTHS_WITHDRAWALS IS NULL THEN 0 ELSE 0 END AS has_12_months_withdrawals,
	-- LAST_6_MONTHS_WITHDRAWALS,
	-- LAST_3_MONTHS_WITHDRAWALS,
	-- LAST_1_MONTHS_WITHDRAWALS
 from DS_DATA_2;
create or replace view TRAINING_M2_TRAINING(
	ENTITY_ID,
	SEX,
	CLIENT_ADVISER,
	CLIENT_STATUS,
	AGE,
	ACQUISITION,
	VULNERABLE,
	IS_ADVISED,
	IS_HNW,
	IS_SELF_DIRECTED,
	IS_IM_ONLY,
	IS_ADVICE_OPT_OUT,
	IS_IFA,
	DAYS_SINCE_LAST_REVIEW,
	TOTAL_COMPLAINTS,
	LAST_COMPLAINT,
	DAYS_SINCE_LAST_COMPLAINT,
	INVESTMENT_MANAGER,
	TEAM,
	CITS_MANAGER,
	INCORRECT_PRACTICE_LOCATION,
	CLIENT_ANNUAL_ONGOING_INCOME,
	TOTAL_PORTFOLIO_VALUE,
	TOTAL_PORTFOLIO_TCA,
	TOTAL_PORTFOLIO_AUM,
	TOTAL_PORTFOLIO_AUA,
	TOTAL_PORTFOLIO_PULSE_AUM,
	TOTAL_PORTFOLIO_THIRD_PARTY_AUM,
	HAS_12_MONTHS_WITHDRAWALS
) as
SELECT top 10000
	ENTITY_ID,
	--FAMILY_ID,
	--ENTITY_TYPE,	
    SEX,
	--DATE_OF_DEATH,
	CLIENT_ADVISER,
	--ADVISER_FAMILY_COUNT,
	--CLIENT_ADVISER_EXECUTIVE,
	CLIENT_STATUS,
	--DOB,
	AGE,
	ACQUISITION,
	CASE WHEN VULNERABILITY_REASON_DETAIL is NULL THEN 0 ELSE 1 END as Vulnerable,
	--LAST_LOGIN_DATE,
	--MARKETING_PREFERENCES,
	--MAILING_METHOD,
	-- SERVICE_PROPOSITION like '%opt out%',  ,
	-- CREATED_DATE,
	-- CLIENT_ADVISER_IS_REMOTE,
	-- PROPOSED_PRACTICE,
	-- CLIENT_ADVISER_PRACTICE,
	IS_ADVISED,
	IS_HNW,
	IS_SELF_DIRECTED,
	IS_IM_ONLY,
	IS_ADVICE_OPT_OUT,
	IS_IFA,
	-- LAST_REVIEW,
	DAYS_SINCE_LAST_REVIEW,
	TOTAL_COMPLAINTS,
	LAST_COMPLAINT,
	DAYS_SINCE_LAST_COMPLAINT,
	-- TOTAL_FAMILY_RELATIONSHIPS,
	INVESTMENT_MANAGER,
	TEAM,
	CITS_MANAGER,
	-- CLIENT_START,
	-- SOURCE_OF_WEALTH,
	-- MARITAL_STATUS,
	-- SOURCE_OF_WEALTH2,
	-- ACQUISITION2,
	-- PRODUCTS,
	-- TOTAL_ADVISERS,
	-- LAST_ADVISER_CHANGE,
	INCORRECT_PRACTICE_LOCATION,
	-- PROPOSED_PRACTICE2,
	CLIENT_ANNUAL_ONGOING_INCOME,
	TOTAL_PORTFOLIO_VALUE,
	TOTAL_PORTFOLIO_TCA,
	TOTAL_PORTFOLIO_AUM,
	TOTAL_PORTFOLIO_AUA,
	TOTAL_PORTFOLIO_PULSE_AUM,
	TOTAL_PORTFOLIO_THIRD_PARTY_AUM,
	-- ACQUISITION3,
	CASE WHEN CAST(LAST_12_MONTHS_WITHDRAWALS as int) < -20000 THEN 1 WHEN LAST_12_MONTHS_WITHDRAWALS IS NULL THEN 0 ELSE 0 END AS has_12_months_withdrawals,
	-- LAST_6_MONTHS_WITHDRAWALS,
	-- LAST_3_MONTHS_WITHDRAWALS,
	-- LAST_1_MONTHS_WITHDRAWALS
 from DS_DATA_2;
CREATE OR REPLACE FILE FORMAT CSV_BASIC
	SKIP_HEADER = 1
;
CREATE OR REPLACE FILE FORMAT DS_DATA2
	PARSE_HEADER = TRUE
;
create or replace stream COMPLETE_STR on table COMPLETE_TBL append_only = true;
create or replace stream COMPLETE_STREAM on table COMPLETE_TBL append_only = true;
create or replace streamlit C82P8UU_V0RHTI_Z
	root_location='@DEV_POC.RJ."C82P8UU_V0RHTI_Z (Stage)"
	main_file='/streamlit_app.py'
	query_warehouse='DEV_BI_WH_XS'
	comment='{"lastUpdatedUser":"5207348180232","lastUpdatedTime":1740735551228}'
	title='Test';
create or replace streamlit M9VK6ZAKDQ78VGVB
	root_location='@DEV_POC.RJ."M9VK6ZAKDQ78VGVB (Stage)"
	main_file='/streamlit_app.py'
	query_warehouse='DEV_BI_WH_XS'
	comment='{"lastUpdatedUser":"5207348180232","lastUpdatedTime":1740750778179}'
	title='Bespoke Hierarchy Config';
create or replace schema SCHEMACHANGE;

create or replace TABLE CHANGE_HISTORY (
	VERSION VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	SCRIPT VARCHAR(16777216),
	SCRIPT_TYPE VARCHAR(16777216),
	CHECKSUM VARCHAR(16777216),
	EXECUTION_TIME NUMBER(38,0),
	STATUS VARCHAR(16777216),
	INSTALLED_BY VARCHAR(16777216),
	INSTALLED_ON TIMESTAMP_LTZ(9)
);
create or replace schema WEATHER;

create or replace dynamic table ANALYSIS_DTBL(
	DATA_KEY,
	POSTAL_CODE,
	COUNTRY,
	DATE_VALID_STD,
	MAX_WIND_SPEED_80M_MPS,
	MAX_WIND_SPEED_10M_MPS,
	MAX_WIND_SPEED_100M_MPS,
	MAX_PRESSURE_MEAN_SEA_LEVEL_MB
) target_lag = '1 minute' refresh_mode = INCREMENTAL initialize = ON_CREATE warehouse = DEV_BI_WH_XS
 as

    SELECT
        CONCAT(POSTAL_CODE || TO_VARCHAR(15), COUNTRY || TO_VARCHAR(15), DATE_VALID_STD || TO_VARCHAR(15)) AS DATA_KEY, 
        POSTAL_CODE, COUNTRY, DATE_VALID_STD, MAX_WIND_SPEED_80M_MPS, MAX_WIND_SPEED_10M_MPS, MAX_WIND_SPEED_100M_MPS, MAX_PRESSURE_MEAN_SEA_LEVEL_MB 
    FROM STAGING_TBL;
create or replace TABLE ANALYSIS_HISTORY_TBL (
	VALID_FROM TIMESTAMP_NTZ(9),
	VALID_TO TIMESTAMP_NTZ(9),
	CURRENT_RECORD NUMBER(38,0),
	DATA_KEY VARCHAR(16777216),
	POSTAL_CODE VARCHAR(20),
	COUNTRY VARCHAR(2),
	DATE_VALID_STD DATE,
	MAX_WIND_SPEED_80M_MPS NUMBER(38,1),
	MAX_WIND_SPEED_10M_MPS NUMBER(38,1),
	MAX_WIND_SPEED_100M_MPS NUMBER(38,1),
	MAX_PRESSURE_MEAN_SEA_LEVEL_MB NUMBER(38,1)
);
create or replace TABLE LOG (
	TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP(),
	ACTION VARCHAR(200),
	STATUS VARCHAR(200),
	MESSAGE VARCHAR(200)
);
create or replace TABLE STAGING_TBL (
	SOURCE VARCHAR(25),
	POSTAL_CODE VARCHAR(20),
	COUNTRY VARCHAR(2),
	DATE_VALID_STD DATE,
	MAX_WIND_SPEED_80M_MPS NUMBER(38,1),
	MAX_WIND_SPEED_10M_MPS NUMBER(38,1),
	MAX_WIND_SPEED_100M_MPS NUMBER(38,1),
	MAX_PRESSURE_MEAN_SEA_LEVEL_MB NUMBER(38,1),
	constraint PK_STAGING_TBL_DATE_KEY primary key (DATE_VALID_STD)
);
create or replace view DS_ALL(
	MAX_WIND_SPEED_80M_MPS,
	MAX_WIND_SPEED_10M_MPS,
	MAX_WIND_SPEED_100M_MPS,
	MAX_PRESSURE_MEAN_SEA_LEVEL_MB
) as

    SELECT
    	MAX_WIND_SPEED_80M_MPS,
    	MAX_WIND_SPEED_10M_MPS,
    	MAX_WIND_SPEED_100M_MPS,
    	MAX_PRESSURE_MEAN_SEA_LEVEL_MB
    FROM
        ANALYSIS_DTBL
    ORDER BY
        DATA_KEY DESC;
create or replace view DS_TRAINING(
	MAX_WIND_SPEED_80M_MPS,
	MAX_WIND_SPEED_10M_MPS,
	MAX_WIND_SPEED_100M_MPS,
	MAX_PRESSURE_MEAN_SEA_LEVEL_MB
) as

    SELECT TOP 3000
    	MAX_WIND_SPEED_80M_MPS,
    	MAX_WIND_SPEED_10M_MPS,
    	MAX_WIND_SPEED_100M_MPS,
    	MAX_PRESSURE_MEAN_SEA_LEVEL_MB
    FROM
        ANALYSIS_DTBL
    ORDER BY
        DATA_KEY DESC;
create or replace view STAGING_TBL_MASKING(
	POSTAL_CODE WITH MASKING POLICY DEV_POC.WEATHER.MASK_POSTAL_CODE,
	COUNTRY,
	DATE_VALID_STD,
	MAX_WIND_SPEED_80M_MPS
) as 

    SELECT
    	POSTAL_CODE,
    	COUNTRY,
    	DATE_VALID_STD,
    	MAX_WIND_SPEED_80M_MPS
    FROM
        STAGING_TBL;
create or replace view STAGING_V(
	SOURCE,
	POSTAL_CODE,
	COUNTRY,
	DATE_VALID_STD,
	MAX_WIND_SPEED_80M_MPS,
	MAX_WIND_SPEED_10M_MPS,
	MAX_WIND_SPEED_100M_MPS,
	MAX_PRESSURE_MEAN_SEA_LEVEL_MB
) as

    SELECT
        'WEATHER_DATA.FORECAST_DAY' AS SOURCE, POSTAL_CODE, COUNTRY, DATE_VALID_STD, MAX_WIND_SPEED_80M_MPS, MAX_WIND_SPEED_10M_MPS, MAX_WIND_SPEED_100M_MPS, MAX_PRESSURE_MEAN_SEA_LEVEL_MB
    FROM
        WEATHER_DATA.ONPOINT_ID.FORECAST_DAY 
    WHERE
        DATE_VALID_STD  = (SELECT MIN(DATE_VALID_STD) FROM WEATHER_DATA.ONPOINT_ID.FORECAST_DAY)
    
    UNION
    
    SELECT DISTINCT
        'WEATHER_DATA.HISTORY_DAY' AS SOURCE, POSTAL_CODE, COUNTRY, DATE_VALID_STD, MAX_WIND_SPEED_80M_MPS, MAX_WIND_SPEED_10M_MPS, MAX_WIND_SPEED_100M_MPS, MAX_PRESSURE_MEAN_SEA_LEVEL_MB
    FROM
        WEATHER_DATA.ONPOINT_ID.HISTORY_DAY
    WHERE
        DATE_VALID_STD <> (SELECT MIN(DATE_VALID_STD) FROM WEATHER_DATA.ONPOINT_ID.FORECAST_DAY);
CREATE OR REPLACE PROCEDURE "ANALYSIS_HISTORY_IMPORT"()
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS OWNER
AS '

DECLARE ERR_MSG STRING;

BEGIN
    -- Log start status
    INSERT INTO WEATHER.LOG (ACTION, STATUS) VALUES (''Import ANALYSIS_TBL --> ANALYSIS_HISTORY_TBL'', ''Started''); 
 
    UPDATE
        ANALYSIS_HISTORY_TBL AS target 
    SET
        target.VALID_TO = current_timestamp,  -- Set end_date to today''s date for expired records
        target.CURRENT_RECORD = 0
    FROM
        ANALYSIS_DTBL AS source
    WHERE
        target.DATA_KEY = source.DATA_KEY AND
        (
            target.POSTAL_CODE != source.POSTAL_CODE OR 
            target.COUNTRY != source.COUNTRY OR
            target.DATE_VALID_STD != source.DATE_VALID_STD OR
            target.MAX_WIND_SPEED_80M_MPS != source.MAX_WIND_SPEED_80M_MPS OR
            target.MAX_WIND_SPEED_10M_MPS != source.MAX_WIND_SPEED_10M_MPS OR
            target.MAX_WIND_SPEED_100M_MPS != source.MAX_WIND_SPEED_100M_MPS OR
            target.MAX_PRESSURE_MEAN_SEA_LEVEL_MB != source.MAX_PRESSURE_MEAN_SEA_LEVEL_MB
        )  -- Check if data has changed
      AND target.VALID_TO IS NULL;  -- Only update active records
 
INSERT INTO ANALYSIS_HISTORY_TBL (

    DATA_KEY,
    CURRENT_RECORD,
    POSTAL_CODE, 
    COUNTRY, 
    DATE_VALID_STD, 
    MAX_WIND_SPEED_80M_MPS, 
    MAX_WIND_SPEED_10M_MPS, 
    MAX_WIND_SPEED_100M_MPS, 
    MAX_PRESSURE_MEAN_SEA_LEVEL_MB,
    VALID_FROM,
    VALID_TO

)

SELECT 
    source.DATA_KEY,
    1 AS CURRENT_RECORD,
    source.POSTAL_CODE, 
    source.COUNTRY, 
    source.DATE_VALID_STD, 
    source.MAX_WIND_SPEED_80M_MPS, 
    source.MAX_WIND_SPEED_10M_MPS, 
    source.MAX_WIND_SPEED_100M_MPS, 
    source.MAX_PRESSURE_MEAN_SEA_LEVEL_MB,
    CURRENT_TIMESTAMP AS VALID_FROM,
    NULL AS VALID_TO
FROM
    ANALYSIS_DTBL AS source
    LEFT JOIN ANALYSIS_HISTORY_TBL AS target ON target.DATA_KEY = source.DATA_KEY AND target.VALID_TO IS NULL    
WHERE
    target.DATA_KEY IS NULL
   OR (
        target.POSTAL_CODE != source.POSTAL_CODE OR 
        target.COUNTRY != source.COUNTRY OR
        target.DATE_VALID_STD != source.DATE_VALID_STD OR
        target.MAX_WIND_SPEED_80M_MPS != source.MAX_WIND_SPEED_80M_MPS OR
        target.MAX_WIND_SPEED_10M_MPS != source.MAX_WIND_SPEED_10M_MPS OR
        target.MAX_WIND_SPEED_100M_MPS != source.MAX_WIND_SPEED_100M_MPS OR
        target.MAX_PRESSURE_MEAN_SEA_LEVEL_MB != source.MAX_PRESSURE_MEAN_SEA_LEVEL_MB
    );
 
    -- Log success
    
    INSERT INTO WEATHER.LOG (ACTION, STATUS) VALUES (''Import ANALYSIS_TBL --> ANALYSIS_HISTORY_TBL'', ''Completed''); 
 
    RETURN ''History Load Completed'';    

    	
EXCEPTION

    WHEN OTHER THEN
    
        ERR_MSG := SQLERRM;
      
        INSERT INTO WEATHER.LOG (ACTION, STATUS, MESSAGE) VALUES (''Import STAGING_V --> STAGING_TBL'', ''Failed'', :ERR_MSG);  
    
    RETURN ''Error occurred: '' || SQLSTATE || '' (Code: '' || SQLCODE || '', Msg: '' || SQLERRM || '')'';
		 
END;

';
CREATE OR REPLACE PROCEDURE "STAGING_TBL_IMPORT"()
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS CALLER
AS '

DECLARE 

    ERR_MESSAGE STRING;

BEGIN

    TRUNCATE TABLE WEATHER.STAGING_TBL;

    INSERT INTO STAGING_TBL SELECT * FROM WEATHER.STAGING_V;

    INSERT INTO WEATHER.LOG (ACTION, STATUS) VALUES (''Import STAGING_V --> STAGING_TBL'', ''Passed''); 

    RETURN ''Logged Successfully'';
        
EXCEPTION
    WHEN OTHER THEN 

    ERR_MESSAGE := SQLERRM;
   
    INSERT INTO WEATHER.LOG (ACTION, STATUS, MESSAGE) VALUES (''Import STAGING_V --> STAGING_TBL'', ''Failed'', :ERR_MESSAGE);     

    RETURN ''Error Logged: '' || ERR_MESSAGE;

END;

';
create or replace task ANALYSIS_HISTORY_TBL_IMPORT_TK
	warehouse=DEV_BI_WH_XS
	schedule='USING CRON 5 0 * * * UTC'
	as CALL ANALYSIS_HISTORY_IMPORT();
create or replace task STAGING_TBL_IMPORT_TK
	warehouse=DEV_BI_WH_XS
	schedule='USING CRON 0 0 * * * UTC'
	as CALL DEV_POC.WEATHER.STAGING_TBL_IMPORT();
create or replace masking policy MASK_POSTAL_CODE as (POSTAL_CODE VARCHAR) 
returns VARCHAR ->
CASE
        WHEN CURRENT_ROLE() = 'DEV_ANALYST' THEN 'XXXX' || RIGHT(POSTAL_CODE, 4) -- Mask all except last 4 characters
        ELSE POSTAL_CODE -- Show full ISIN for other roles
    END
;